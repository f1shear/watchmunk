{% extends "base/base.html" %}
{% block page %}
  {% verbatim %}
  <div id='systemDetailVue'>
    <div class='row' v-if='project!=null'>
      <div class='col'>
        <h4>
        <a href='/dashboard'> Projects </a>
        >
        <a :href='"/projects/"+project.id' class='text-muted'> {{project.name}} </a>
        >
        <a :href='"/projects/"+project.id+"/systems/"+system.id+"/"' class='text-muted'> {{system.name}} </a>
        </h4>
      </div>
    </div>
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="pills-system-details-tab" data-toggle="pill" href="#pills-system-details" role="tab" aria-controls="pills-system-details" aria-selected="true">System Details</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="pills-apps-tab" data-toggle="pill" href="#pills-apps" role="tab" aria-controls="pills-apps" aria-selected="false">Apps/Integrations</a>
      </li>
    </ul>
    <div class="tab-content" id="pills-tabContent">
      <div class="tab-pane fade show active" id="pills-system-details" role="tabpanel" aria-labelledby="pills-system-details-tab">
            <div class='row'>
              <div class='col-md-6'>
            <h4> System Details </h4>
            <form v-on:submit.prevent="saveSystem">
              <div class='row'>
                <div class='col-md-4'>
                  <div class="form-group">
                    <label for="systemName">System Name</label>
                    <input type="text" class="form-control" id="systemName" aria-describedby="systemNameHelp" v-model='system.name'>
                  </div>
                  <div class="form-group">
                    <label for="description"> Description </label>
                    <textarea class='form-control' id="description" v-model="system.description"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="deploymentType"> Deployment Type </label>
                    <select id='systemType' v-model='system.deployment_type' class='form-control'>
                      <option value=''>----</option>
                      <option v-for="option in deploymentTypes" v-bind:value="option.type">
                        {{ option.label }}
                      </option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="systemType">System Type</label>
                    <select id='systemType' v-model='system.system_type' class='form-control'>
                      <option value=''>----</option>
                      <option v-for="option in systemTypes" v-bind:value="option.type">
                        {{ option.label }}
                      </option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="documentation"> Documentation </label>
                    <textarea class='form-control' id="documentation" v-model="system.documentation"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="apiInfo"> API Info </label>
                    <textarea  class='form-control'  id="apiInfo" v-model="system.api_info"></textarea>
                  </div>
                </div>
                <div class='col-md-8'>
                  <div class="form-group">
                    <label for="repoInfo"> Repository Info </label>
                    <textarea  class='form-control'  id="repoInfo" v-model="system.repo_info"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="environmentConfig"> Environment Config </label>
                    <textarea  class='form-control'  id="environmentConfig" v-model="system.environment_config"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="stagingInfo"> Staging Info </label>
                    <textarea  class='form-control'  id="stagingInfo" v-model="system.staging_info"></textarea>
                  </div>
                  <div class="form-group">
                    <label for="productionInfo"> Production Info </label>
                    <textarea  class='form-control'  id="productionInfo" v-model="system.production_info"></textarea>
                  </div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save</button>
            </form>
          </div>
          <div class='col-md-6'>
            <br>
            <div class='row'>
              <div class='col-md-6'>
                <h4> Add Moderator </h4>
                <ul class='scrollable-list'>
                  <li v-for='user in filteredUsers'>
                    <button class='btn btn-sm' title='Add' v-on:click='addModerator(user)'> + </button> {{user.username}}
                  </li>
                </ul>
              </div>
              <div class='col-md-6'>
                <h4> Moderators </h4>
                <ul class='scrollable-list'>
                  <li v-for='moderator in systemModerators'>
                  <button class='btn btn-sm' title='Remove' v-on:click='removeModerator(moderator)'> - </button> {{moderator.moderator.username}} 
                  </li>
                </ul>
              </div>
            </div>
            <hr>
            <br>
            <div class='row'>
              <div class='col-md-6'>
                <h4> Add Dependency </h4>
                <ul class='scrollable-list'>
                  <li v-for='sys in filteredSystems'>
                    <button class='btn btn-sm' title='Add' v-on:click='addDependency(sys)'> + </button> {{sys.name}}
                  </li>
                </ul>

              </div>
              <div class='col-md-6'>
                <h4> Dependecies </h4>
                <ul class='scrollable-list'>
                  <li v-for='dep in systemDependencies'>
                  <button class='btn btn-sm' title='Remove' v-on:click='removeDependency(dep)'> - </button> {{dep.depends_on.name}} 
                  </li>
                </ul>
              </div>
            </div>



          </div>
        </div>

      </div>
      <div class="tab-pane fade" id="pills-apps" role="tabpanel" aria-labelledby="pills-apps-tab">
      
        <div class='row'>
        <div class='col-md-3'>
          <br>
          <b> Integrated Applications </b>
          <ul class="list-group">
            <li class="list-group-item" v-for='app in systemApps' v-bind:class="{ active: selectedApp != '' && selectedApp.app.id == app.app.id }" v-on:click='setSelectedApp(app)'>
              {{app.app.name}}
            </li>
          </ul>

          <br><br>

          <!-- Button trigger modal -->
          <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addApplicationModal">
           + Add New Application
          </button>

          <br>

          
        </div>

        <div class='col-md-9'>
          
          <div v-if='selectedApp==""'>
            <br><br>
            No app selected.
          </div>
          <div v-if='selectedApp!=""'>
            <b> App Posts </b> <hr>
            <button class='btn btn-primary btn-sm float-right'  data-toggle="modal" data-target="#removeApplicationModal">
              Remove
            </button>
            <span class='badge badge-primary'> {{selectedApp.app.name}} </span>
            <hr>
            <div v-for='post in appPosts'>
              {{post}}
            </div>
            <p v-if='selectedApp != "" && appPosts.length==0'>
              No app posts!
            </p>
          </div>
        </div>
      </div>
      </div>
    </div>



<!-- Modal -->
<div class="modal fade" id="addApplicationModal" tabindex="-1" role="dialog" aria-labelledby="addApplicationModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addApplicationModalLabel"> Add New Application </h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form v-on:submit.prevent="addApplication">

          <div class='form-group'>
            <select class='form-control' v-model='addAppForm.app'>
              <option value='' selected> - - - - </option>
              <option v-for='app in filteredApps' :value='app.id'>
                {{app.name}}
              </option>
              </select>
          </div>

          <button class='btn btn-primary btn-sm' type='submit'> Add </button>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="removeApplicationModal" tabindex="-1" role="dialog" aria-labelledby="removeApplicationModalLabel" aria-hidden="true" v-if="selectedApp!=''">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="removeApplicationModalLabel">Are you sure?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        The application <span class='badge badge-primary'> {{selectedApp.app.name}} </span> will be removed and its posts will be deleted ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" v-on:click='removeApplication'>Confirm</button>
      </div>
    </div>
  </div>
</div>

  </div>
  <script type="text/javascript">
  var systemDetailVue = new Vue({
      el: '#systemDetailVue',
      data: {
          projectID: null,
          systemID: null,
          integrations: [],
          project: null,
          system: {
              name: '',
              system_type: '',
              repo_info: '',
              environment_config: '',
              staging_info: '',
              production_info: '',
              api_info: '',
              documentation: '',
              deployment_type: '',
              author: {},
          },
          systemModerators: [],
          systemApps: [],
          systemDependencies: [],
          users: [],
          systems: [],
          deploymentTypes: [{
                  'type': 'shared',
                  'label': 'Shared Hosting'
              },
              {
                  'type': 'dedicated',
                  'label': 'Dedicated Server'
              },
              {
                  'type': 'vm',
                  'label': 'Virtual Machine'
              },
              {
                  'type': 'container',
                  'label': 'Container'
              },
              {
                  'type': 'service',
                  'label': 'Service'
              }
          ],
          systemTypes: [{
                  'type': 'worker',
                  'label': 'Worker'
              },
              {
                  'type': 'system',
                  'label': 'System'
              },
              {
                  'type': 'storage',
                  'label': 'Storage'
              },
              {
                  'type': 'queue',
                  'label': 'Queue'
              },
              {
                  'type': 'database',
                  'label': 'Database'
              },
              {
                  'type': 'web',
                  'label': 'Web'
              },
              {
                  'type': 'client/web',
                  'label': 'Web Client'
              },
              {
                  'type': 'client/desktop',
                  'label': 'Desktop Client'
              },
              {
                  'type': 'client/mobile',
                  'label': 'Mobile Client'
              }
          ],
          selectedApp: '',
          appPosts: [],
          apps: [],
          addAppForm: {
              app: '',
              system: '',
          }
      },
      methods: {
          loadProject: function(projectID) {
              var that = this;
              $.get("/api/v1/projects/" + projectID + "/", function(data) {
                  that.project = data;
              });
          },
          loadSystem: function(projectID, systemID) {
              var that = this;
              $.get("/api/v1/projects/" + projectID + "/systems/" + systemID + "/", function(data) {
                  that.system = data;
              });
          },
          saveSystem: function() {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/",
                  type: 'PUT',
                  success: function(data) {
                      alert("Saved!");
                      that.project = data;
                  },
                  data: that.system
              });
          },
          addSystem: function() {
              var that = this;
              $.post("/api/v1/projects/" + this.projectID + "/systems/", that.system, function(data) {
                  alert("Added System!");
                  that.loadSystems(that.projectID);
                  $('#addSystemModal').modal('hide');
              });
          },
          extractURLInfo: function() {
              var path = window.location.pathname.split('/');
              var trailingPad = 0;
              if (path[path.length - 1] == '') {
                  trailingPad = 1;
              }
              return {
                  systemID: path[path.length - 1 - trailingPad],
                  projectID: path[path.length - 3 - trailingPad],
              };
          },
          loadSystemApps: function(projectID, systemID) {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + projectID + "/systems/" + systemID + "/apps/",
                  type: 'GET',
                  success: function(data) {
                      that.systemApps = data['results'];
                  }
              });
          },
          loadApps: function() {
              var that = this;
              $.ajax({
                  url: "/api/v1/apps/",
                  type: 'GET',
                  success: function(data) {
                      that.apps = data['results'];
                  }
              });
          },
          setSelectedApp: function(app) {
              this.selectedApp = app;
              this.loadAppPosts();
          },
          loadAppPosts: function() {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/apps/" + this.selectedApp.id + "/posts/",
                  type: 'GET',
                  success: function(data) {
                      var appPosts = data['results'];
                      var template = that.selectedApp.app.message_template;
                      that.appPosts = [];

                      for (var i = 0; i < appPosts.length; i++) {

                          var post = JSON.parse(appPosts[i].post);
                          msg = Mustache.render(template, post);
                          that.appPosts.push(msg);
                      }
                  }
              });
          },
          loadModerators: function() {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/moderators/",
                  type: 'GET',
                  success: function(data) {
                      that.systemModerators = data['results'];
                  }
              });
          },
          loadDependencies: function() {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/dependencies/",
                  type: 'GET',
                  success: function(data) {
                      that.systemDependencies = data['results'];
                  }
              });
          },
          loadSystems: function(projectID) {
              var that = this;
              $.get("/api/v1/projects/" + projectID + "/systems/", function(data) {
                  that.systems = data['results'];
              });
          },
          loadUsers: function() {
              var that = this;
              $.get("/api/v1/users/", function(data) {
                  that.users = data['results'];
              });
          },
          addDependency: function(sys) {
              var that = this;
              var payload = {
                  system: this.system.id,
                  depends_on: sys.id
              }

              $.post("/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/dependencies/", payload, function(data) {

                  that.loadDependencies();
              });

          },
          removeDependency: function(dep) {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/dependencies/" + dep.id + "/",
                  type: 'DELETE',
                  success: function() {

                      that.loadDependencies();
                  }
              });
          },
          addModerator: function(user) {

              var that = this;
              var payload = {
                  system: this.system.id,
                  moderator: user.id
              }

              $.post("/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/moderators/", payload, function(data) {

                  that.loadModerators();
              });

          },
          removeModerator: function(mod) {
              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/moderators/" + mod.id + "/",
                  type: 'DELETE',
                  success: function() {

                      that.loadModerators();
                  }
              });

          },
          addApplication: function() {
              var that = this;
              var payload = {
                  app: this.addAppForm.app,
                  system: this.systemID
              }

              $.post("/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/apps/", payload, function(data) {

                  that.loadSystemApps(that.projectID, that.systemID);
                  $('#addApplicationModal').modal('hide');
              });

          },
          removeApplication: function() {

              var that = this;
              $.ajax({
                  url: "/api/v1/projects/" + this.projectID + "/systems/" + this.systemID + "/apps/" + this.selectedApp.id + "/",
                  type: 'DELETE',
                  success: function() {

                      that.selectedApp = '';
                      that.loadSystemApps(that.projectID, that.systemID);
                      $('#removeApplicationModal').modal('hide');
                  }
              });
          }

      },

      computed: {

          filteredSystems: function() {
              var filtered = [];
              var dependencies_dict = {};

              for (var i = 0; i < this.systemDependencies.length; i++) {
                  var dep = this.systemDependencies[i];
                  dependencies_dict[dep.depends_on.id] = true;
              }

              for (var j = 0; j < this.systems.length; j++) {

                  if (!(this.systems[j].id in dependencies_dict)) {
                      filtered.push(this.systems[j])
                  }

              }

              return filtered;
          },

          filteredApps: function() {
              var filtered = [];
              var existing = {};

              for (var i = 0; i < this.systemApps.length; i++) {
                  var systemApp = this.systemApps[i];
                  existing[systemApp.app.id] = true;
              }

              for (var j = 0; j < this.apps.length; j++) {

                  if (!(this.apps[j].id in existing)) {
                      filtered.push(this.apps[j])
                  }

              }

              return filtered;
          },
          filteredUsers: function() {

              var filtered = [];
              var moderators_dict = {};

              for (var i = 0; i < this.systemModerators.length; i++) {
                  var mod = this.systemModerators[i];
                  moderators_dict[mod.moderator.id] = true;
              }

              for (var j = 0; j < this.users.length; j++) {

                  if (!(this.users[j].id in moderators_dict)) {
                      filtered.push(this.users[j]);
                  }

              }

              return filtered;

          },
      },
      mounted: function() {
          var urlInfo = this.extractURLInfo();

          this.projectID = urlInfo['projectID'];
          this.systemID = urlInfo['systemID'];
          this.loadApps();
          this.loadProject(urlInfo['projectID']);
          this.loadSystem(urlInfo['projectID'], urlInfo['systemID']);
          this.loadSystemApps(urlInfo['projectID'], urlInfo['systemID']);
          this.loadUsers();
          this.loadSystems(urlInfo['projectID']);
          this.loadModerators();
          this.loadDependencies();
      }
  });
  </script>
{% endverbatim %}
{% endblock %}